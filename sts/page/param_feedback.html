<style type="text/css">
.data-dia .radio-wefeed{display: inline-block; cursor: pointer; padding-left: 22px; background: url(images/radio.png) no-repeat left -16px;background-size: 16px;}
.data-dia .radio-current{background-position: left 3px;}
.data-dia .rule-main .emotion-editor{margin-top:20px;}
</style>
<div class="main-content">
    <div class="qrcode-setting setting-box">
        <p class="tips">设置带参数二维码的回复规则，当用户扫描带参数二维码，即可把您设置在此规则名中回复的内容自动发送给订阅用户。</p>
        <p><span class="orange-button lit-orange js-add-rule"><i class="icon20-white-add"></i>添加规则</span></p>
    </div>
    <div class="info-list">
        <table class="list">
            <thead style="text-align: center">
                <tr>
                    <th>规则名</th>
                    <th width="40%">二维码配置</th>
                    <th width="25%">回复消息</th>
                    <th width="18%">操作</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>zhangsan</td>
                    <td>张三</td>
                    <td>美乐乐旗舰店</td>
                    <td>
                        <a href="javascript:;" onclick="editQrRule('9314|zhangsan|1,2,5|');">编辑</a>
                        <a href="javascript:;" class="red-button" onclick="dialog('delAccount');">删除</a>
                    </td>
                </tr>
                <tr class="odd">
                    <td>大张三</td>
                    <td>13800000000</td>
                    <td>美乐乐旗舰店</td>
                    <td>
                        <a href="javascript:;" onclick="editQrRule('9314|');">编辑</a>
                        <a href="javascript:;" class="red-button" onclick="delQrRule(9314);">删除</a>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="page-bar">
        <a class="prev" href="#" style="width:66px;">&lt; 上一页</a>
        <a href="#">1</a>
        <strong>2</strong>
        <a href="#">3</a>
        <span class="dot">…</span>
        <a href="#">150</a>
        <a class="next" href="#" style="width:66px;">下一页 &gt;</a>
        <span class="no-border">到第<input  onkeyup="__goPageE(this,event);">页</span>
        <a class="button" href="javascript:;" onclick="__goPage(this);" style="width:50px;">确定</a>
        <span class="total-info">共20页</span>
        <span class="total-info">198项</span>
    </div>
</div>
<!-- 添加规则弹框内容 start -->
<div class="addQrRule" style="display:none;">
    <p>
        <span class="lab">规则名</span>
        <input type="text" class="input js-rulename" placeholder="输入规则名，最多60个字，规则名是唯一的" />
        <span class="rulename-tips">规则名最多为60个字</span>
    </p>
    <p>
        <span class="lab">选择二维码</span>
        <span class="choose-qr-btn js-cho-qr"><i class="icon20-gray-add"></i>选择二维码</span>
    </p>
    <p>
        <span class="lab">回复内容</span>
        <span>
            <span class="radio-wefeed radio-current" data-role="0">图文消息</span>&emsp;&emsp;
            <span class="radio-wefeed" data-role="1">文字消息</span>
        </span>
    </p>
    <div class="rule-main">
        <div class="js-main1"></div>
        <div class="js-main2" style="display:none;"></div>
    </div>
</div>
<!-- 添加规则弹框内容 end -->
<!-- 选择二维码弹框内容 start -->
<div class="chooseQRcode" style="display:none;">
    <div class="qr-choose-box clearfix">
        <dl>
            <dt>二维码列表</dt>
            <dd>
                <div class="qr-search-box">
                    <input type="input" class="input" placeholder="请输入二维码ID或描述进行搜索" />
                    <span class="qr-search-btn js-search-qr"></span>
                </div>
                <div class="table-box">
                    <table class="js-qrlist search-list">
                        <thead>
                            <tr>
                                <td width="20%"></td>
                                <td>二维码ID</td>
                                <td>描述</td>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </dd>
        </dl>
        <dl>
            <dt>已选择二维码<span class="js-choosed-num">（7条）</span></dt>
            <dd>
                <ul class="js-qrlist-choed">
                    <li>
                        <span>1.2050年周年庆</span>
                        <span class="js-del-choed del-span" data-role="2"></span>
                    </li>
                </ul>
            </dd>
        </dl>
        <span class="spera"></span>
    </div>
</div>
<!-- 选择二维码弹框内容 end -->
<script type="text/javascript">
//使用全局变量存储已经选择qrID
window.__chosedQR = {id:[2],desc:['2015美丽金秋...']};
!function(){
    //添加规则弹框内容中调用公共模块 information.html
    $('.js-main1').load('page/information.html',function(){
        //information中方法weFeedShow
        weFeedShow('运营',[]);
    });
    $('.js-main2').load('page/text_msg.html',function(){removeFooter();});

    $('.js-add-rule').on('click',function(){
        
        //初始化选定规则
        window.__chosedQR = { id: [],desc: [] };
        initChoedQR();

        $.lightBox({
            width: 975,
            boxID: 'addQrRule',
            title: '添加规则',
            html: $('.addQrRule').html(),
            buttons: [{
                value: '重  置',
                className: 'dia-close cancel-button'
            },{
                value: '确  认',
                className: 'bright-button',
                callbackFun: function(){
                    console.log('do some');
                }
            }]
        });

        //选择二维码事件
        choQREvent();
            
        $('.data-dia .radio-wefeed').on('click',function(){
            $('.data-dia .radio-wefeed').removeClass('radio-current');
            var index = $(this).attr('data-role');
            $('.data-dia .rule-main').children().hide().eq(index).show();
            $(this).addClass('radio-current');
        });
    });
}();
/**
 * [editQrRule 编辑规则弹框展示]
 * @param  {[string]} ruleInfo [表示当前规则信息，各数据项以'|'分隔，依次是规则ID|规则名|配置qrid..]
 * @return {[type]}          [description]
 */
function editQrRule(ruleInfo){
    var info = ruleInfo.split('|');
    if ( info.length < 3 ) {
        $.lightBox({
            html: '信息不全，不能编辑呢！',
            buttons: []
        })
        return;//信息不全不能编辑
    }
    var qrIds = info[2];
    //TODO
    //根据已配置id获取qr信息
    //以下模拟请求复制给window.__chosedQR
    window.__chosedQR = {
        id: [2,5],
        desc: ['2003宇宙大爆炸','2099去可可西里看看海']
    };
     //初始化选定规则
    initChoedQR();

    var editBox = $.lightBox({
        width: 975,
        boxID: 'addQrRule',
        title: '编辑规则',
        html: $('.addQrRule').html(),
        buttons: [{
            value: '取  消',
            className: 'dia-close cancel-button'
        },{
            value: '确  认',
            className: 'bright-button',
            callbackFun: function(){
                console.log('do some');
            }
        }]
    });
    //编辑框内容跟新
    $(editBox).find('.js-rulename').val(info[1]);

    //选择二维码事件
    choQREvent();

    $('.data-dia .radio-wefeed').on('click',function(){
        $('.data-dia .radio-wefeed').removeClass('radio-current');
        var index = $(this).attr('data-role');
        $('.data-dia .rule-main').children().hide().eq(index).show();
        $(this).addClass('radio-current');
    });
}
function delQrRule(qrRuleId){
    $.lightBox({
        width: 390,
        title: '删除确认',
        html: '<p style="text-align:center;">是否确认删除该回复设置？</p>',
        buttons: [{
            value: '取  消',
            className: 'dia-close cancel-button'
        },{
            value: '确  认',
            className: 'bright-button',
            callbackFun: function(){
                //TODO
                //待完善删除二维码规则
            }
        }]
    });
}
function choQREvent(){
    $('.data-dia .js-cho-qr').on('click',function(){
        var that = this;
        var choQRbox = $.lightBox({
            width: 670,
            closeOther: false,
            curDom: $(that),
            boxID: 'chooseQr',
            title: '选择二维码',
            html: $('.chooseQRcode').html(),
            buttons: [{
                value: '确  认',
                className: 'bright-button',
                callbackFun: function(){
                    //更新隐藏DOM中选定二维码
                    initChoedQR();

                    $.lightBox.closeBox($(this));
                }
            }]
        });
        //添加事件
        
        //搜索规则
        $(choQRbox).find('.js-search-qr').on('click',function(){
            var input = $(this).siblings().val();
            var key = input.replace(/(^\s*)|(\s*$)/g, "");
            if( key.length ){
                searchQR(key);
            }
        });

        //已选择规则悬挂效果
        $(choQRbox).find('.js-qrlist-choed li').hover(function(){
            $(this).addClass('hover-li');
        },function(){
            $(this).removeClass('hover-li');
        });

        //点击删除已选择qr
        $(choQRbox).find('.js-del-choed').on('click',function(){
            delChoed(this);
        });
    });
}
/**
 * [searchQR 规则查询处理]
 * @param  {string} keywords [输入查询关键字]
 */
function searchQR(keywords){
    //TODO 
    //AJAX请求数据
    //根据输入查询数据
    //以下json为模拟数据
    var json = [{id: 25,desc: '2051周年清'},{id: 1,desc: '2051周年清'},{id: 2,desc: '2051周年清'}];

    var html = '';
    var checkids = ',' + window.__chosedQR.id.join(',') + ',';
    for(var k in json) {
        html += '<tr><td><span class="';
        if( checkids.indexOf(',' + json[k].id + ',') != -1 ) {
            html += 'checked ';
        }
        html += 'js-qr-check" data-role="' + json[k].id + '=' + json[k].desc + '"></span></td>'
            + '<td>' + json[k].id + '</td>'
            + '<td>' + json[k].desc + '</td>';
    }
    $('.data-dia .js-qrlist tbody').html(html);

    //check事件
    $('.data-dia .js-qr-check').on('click',function(){
        var className = $(this).attr('class');
        if( className.indexOf('checked') == -1 ){
            $(this).addClass('checked');
            chooseQR($(this).data('role'));
        }
    });
}
/**
 * [initChoedQR 初始跟新已选择二维码规则]
 * 初始dom为chooseQRcode
 */
function initChoedQR(){
    var pDomClass = ".chooseQRcode";
    if ( !window.__chosedQR.id.length ) {
        $(pDomClass).find('.js-qrlist-choed').html('');
    } else {
        var html = '',
            ids = window.__chosedQR.id,
            descs = window.__chosedQR.desc;
        for(var i in ids){
            html += '<li><span>' + ( 1 + Number(i) ) + '.' + descs[i] + '</span>' + '<span class="js-del-choed del-span" data-role="' + ids[i] + '"></span></li>';
        }
        $(pDomClass).find('.js-qrlist-choed').html(html);
    }
    //初始已选择qr按钮显示内容
    changeContent($('.js-cho-qr'),window.__chosedQR.id);
}
/**
 * [chooseQR 左边checkbox选择规则处理]
 * @param  {string} qrString [选择规则信息格式=> id=desc 的字符串]
 */
function chooseQR(qrString){
    var qr = qrString.split('=');
    var index = $('.data-dia .js-qrlist-choed').find('li').length;
    var html = '<li><span>' + ( index + 1 ) + '.' + qr[1] + '</span>'
        + '<span class="js-del-choed del-span" data-role="' + qr[0] + '"></span></li>';
    $('.data-dia .js-qrlist-choed').append(html);

    //添加规则
    //TODO
    //后台数据交互
    var thisDom = $('.data-dia .js-qrlist-choed li').eq(index);
    $(thisDom).hover(function(){
        $(this).addClass('hover-li');
    },function(){
        $(this).removeClass('hover-li');
    });
    $(thisDom).find('.js-del-choed').on('click',function(){
        delChoed(this);
    });
    //全局数据变更
    window.__chosedQR.id.push(Number(qr[0]));
    window.__chosedQR.desc.push(qr[1]);
}
/**
 * [delChoed 右边规则删除处理]
 * @param  {dom} obj [点击删除的dom对象，包括data-role属性记录待删除规则ID]
 */
function delChoed(obj){
    var delID = $(obj).data('role');
    //TODO
    //数据库交互删除选定qr
    $(obj).parent().remove();

    for(var m in window.__chosedQR.id){
        if ( window.__chosedQR.id[m] == delID) {
            window.__chosedQR.id.splice(m,1);
            window.__chosedQR.desc.splice(m,1);
        }
    }
}
/**
 * [changeContent 设置选择按钮展示值]
 * @param  {array} objs [显示选择二维码的dom]
 * @param  {array} ids  [已选定二维码id数组]
 */
function changeContent(objs,ids){
    var idString = '',chooseQR = '<i class="icon20-gray-add"></i>选择二维码';
    if ( ids && ids.length > 0 ) {
        idString = ids.join(',');
        chooseQR = '<input type="hidden" name="qrCode" value="' + idString +'" />' + idString;
    }
    $(objs).each(function(){
        $(this).html(chooseQR);
    })

}
</script>